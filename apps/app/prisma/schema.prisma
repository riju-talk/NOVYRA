generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model User {
  id                   String                @id @default(cuid())
  name                 String?
  email                String                @unique
  emailVerified        DateTime?
  image                String?
  role                 Role                  @default(STUDENT)
  bio                  String?
  university           String?
  course               String?
  year                 Int?
  reputation           Int                   @default(0)
  credits              Int                   @default(100)
  subscriptionTier     String                @default("FREE")
  documentCount        Int                   @default(0)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  accounts             Account[]
  achievementUnlocks   AchievementUnlock[]
  aiRecommendations    AIRecommendation[]
  answerVotes          AnswerVote[]          @relation("AnswerVotes")
  answers              Answer[]
  badgeGrants          BadgeGrant[]
  communities          Community[]
  addedDoubts          CommunityDoubt[]
  communityMemberships CommunityMember[]
  conversations        Conversation[]
  doubtVotes           DoubtVote[]           @relation("DoubtVotes")
  doubts               Doubt[]
  leaderboardSnapshots LeaderboardSnapshot[] @relation("UserLeaderboardSnapshots")
  pointsLedger         PointsLedger[]
  streaks              Streak?
  userStats            UserStat?
  discounts            UserDiscount[]
  achievementProgress  AchievementProgress[]
  documents            Document[]
  tier                 String                @default("INITIATE")

  @@index([createdAt])
  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Document {
  id        String   @id @default(cuid())
  userId    String
  title     String
  type      String   @default("PDF") // PDF, TXT, DOCX
  size      Int      @default(0)
  pageCount Int      @default(0)
  url       String?  // Optional URL if we store the file blob somewhere
  pineconeId String? // Optional specific ID if we want to link
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("documents")
}

model Doubt {
  id              String           @id @default(cuid())
  title           String
  content         String
  tags            String[]
  isAnonymous     Boolean          @default(false)
  authorId        String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  subject         String           @default("OTHER")
  downvotes       Int              @default(0)
  upvotes         Int              @default(0)
  isResolved      Boolean          @default(false)
  isInCommunity   Boolean          @default(false)
  answers         Answer[]
  communityDoubts CommunityDoubt[]
  votes           DoubtVote[]
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([createdAt])
  @@index([subject])
  @@index([isInCommunity])
  @@map("doubts")
}

model Answer {
  id         String       @id @default(cuid())
  content    String
  doubtId    String
  authorId   String
  createdAt  DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  isAnswered   String?      @unique @db.Uuid
  isAiAssisted Boolean      @default(false)
  votes        AnswerVote[]
  author     User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  doubt      Doubt        @relation(fields: [doubtId], references: [id], onDelete: Cascade)

  @@index([doubtId])
  @@index([authorId])
  @@index([createdAt])
  @@map("answers")
}

model DoubtVote {
  id        String   @id @default(cuid())
  type      VoteType
  userId    String
  doubtId   String
  createdAt DateTime @default(now())
  doubt     Doubt    @relation(fields: [doubtId], references: [id], onDelete: Cascade)
  user      User     @relation("DoubtVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, doubtId])
  @@index([userId])
  @@index([doubtId])
  @@map("doubt_votes")
}

model AnswerVote {
  id        String   @id @default(cuid())
  type      VoteType
  userId    String
  answerId  String
  createdAt DateTime @default(now())
  answer    Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user      User     @relation("AnswerVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, answerId])
  @@index([userId])
  @@index([answerId])
  @@map("answer_votes")
}

model UserStat {
  id                String   @id @default(cuid())
  userId            String   @unique
  totalPoints       Int      @default(0)
  currentLevel      Int      @default(1)
  doubtsAsked       Int      @default(0)
  doubtsResolved    Int      @default(0)
  commentsPosted    Int      @default(0)
  acceptedAnswers   Int      @default(0)
  upvotesReceived   Int      @default(0)
  downvotesReceived Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([totalPoints])
  @@index([currentLevel])
  @@map("user_stats")
}

model PointsLedger {
  id          String         @id @default(cuid())
  userId      String
  eventType   PointEventType
  points      Int
  description String?
  createdAt   DateTime       @default(now())
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType])
  @@map("points_ledger")
}

model Level {
  id        String   @id @default(cuid())
  level     Int      @unique
  name      String
  minPoints Int
  maxPoints Int?
  icon      String?
  color     String?
  createdAt DateTime @default(now())

  @@index([minPoints])
  @@map("levels")
}

model Achievement {
  id          String              @id @default(cuid())
  type        AchievementType
  name        String              @unique
  description String
  criteria    Json
  points      Int
  rarity      AchievementRarity
  icon        String?
  createdAt   DateTime            @default(now())
  unlocks     AchievementUnlock[]
  progress    AchievementProgress[]

  @@map("achievements")
}

model AchievementUnlock {
  id            String      @id @default(cuid())
  userId        String
  achievementId String
  unlockedAt    DateTime    @default(now())
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId, unlockedAt])
  @@map("achievement_unlocks")
}

model Badge {
  id          String       @id @default(cuid())
  type        BadgeType
  name        String       @unique
  description String
  icon        String?
  color       String?
  createdAt   DateTime     @default(now())
  grants      BadgeGrant[]

  @@map("badges")
}

model BadgeGrant {
  id        String   @id @default(cuid())
  userId    String
  badgeId   String
  grantedAt DateTime @default(now())
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId, grantedAt])
  @@map("badge_grants")
}

model Streak {
  id               String    @id @default(cuid())
  userId           String    @unique
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityDate DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lastActivityDate])
  @@map("streaks")
}

model LeaderboardSnapshot {
  id          String            @id @default(cuid())
  userId      String
  period      LeaderboardPeriod
  scope       LeaderboardScope
  points      Int
  rank        Int
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime          @default(now())
  user        User              @relation("UserLeaderboardSnapshots", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, period, scope, periodStart])
  @@index([period, scope, periodStart])
  @@index([period, scope, rank, periodStart])
  @@map("leaderboard_snapshots")
}

model Conversation {
  id        String    @id @default(cuid())
  userId    String
  title     String?
  context   Json?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[]

  @@index([userId, createdAt])
  @@map("conversations")
}

model AIRecommendation {
  id        String   @id @default(cuid())
  userId    String
  type      String
  metadata  Json?
  createdAt DateTime @default(now())
  content   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("ai_recommendations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  role           String
  content        String
  metadata       Json?
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@map("messages")
}

model UserDiscount {
  id               String       @id @default(cuid())
  userId           String
  discountPercent  Int
  isActive         Boolean      @default(true)
  unlockedAt       DateTime     @default(now())
  expiresAt        DateTime?
  source           String?      // e.g. "Scholar's Oath Achievement"
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_discounts")
}

model AchievementProgress {
  id             String      @id @default(cuid())
  userId         String
  achievementId  String
  current        Int         @default(0)
  target         Int
  lastUpdated    DateTime    @default(now())
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement    Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("achievement_progress")
}

model Community {
  id          String   @id @default(cuid())
  name        String
  description String?
  subject     Subject?
  isPublic    Boolean  @default(true)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User?    @relation(fields: [createdBy], references: [id])

  @@index([createdBy])
  @@index([isPublic])
  @@index([subject])
  @@map("communities")
}

model CommunityMember {
  id          String        @id @default(cuid())
  userId      String
  communityId String
  role        CommunityRole @default(MEMBER)
  joinedAt    DateTime      @default(now())
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@map("community_members")
}

model CommunityDoubt {
  id          String   @id @default(cuid())
  communityId String
  addedBy     String?
  addedAt     DateTime @default(now())
  doubtId     String
  adder       User?    @relation(fields: [addedBy], references: [id])
  doubt       Doubt    @relation(fields: [doubtId], references: [id], onDelete: Cascade)

  @@unique([communityId, doubtId])
  @@index([communityId])
  @@index([doubtId])
  @@map("community_doubts")
}

enum Role {
  STUDENT
  TEACHER
  ADMIN
}

enum Subject {
  COMPUTER_SCIENCE
  MATHEMATICS
  PHYSICS
  CHEMISTRY
  BIOLOGY
  ENGINEERING
  BUSINESS
  LITERATURE
  HISTORY
  PSYCHOLOGY
  OTHER
}

enum VoteType {
  UP
  DOWN
}

enum PointEventType {
  DOUBT_CREATED
  COMMENT_CREATED
  UPVOTE_RECEIVED
  DOWNVOTE_RECEIVED
  ANSWER_ACCEPTED
  DOUBT_RESOLVED
  DAILY_LOGIN
  STREAK_BONUS
  ACHIEVEMENT_UNLOCKED
  BADGE_EARNED
}

enum AchievementType {
  FIRST_DOUBT
  FIRST_COMMENT
  PROBLEM_SOLVER
  STREAK_MASTER
  MENTOR
  TOP_CONTRIBUTOR
  SUBJECT_EXPERT
  COMMUNITY_LEADER
  RISING_STAR
  KNOWLEDGE_SEEKER
}

enum AchievementRarity {
  COMMON
  UNCOMMON
  RARE
  EPIC
  LEGENDARY
}

enum BadgeType {
  AI_MASTER
  PHYSICS_GURU
  MATH_WIZARD
  CODE_NINJA
  BIO_EXPERT
  PROBLEM_SOLVER
  HELPER
  INNOVATOR
  TUTOR
  RESEARCH_STAR
}

enum LeaderboardPeriod {
  DAILY
  WEEKLY
  MONTHLY
  ALL_TIME
}

enum LeaderboardScope {
  GLOBAL
  SUBJECT_CS
  SUBJECT_MATH
  SUBJECT_PHYSICS
  SUBJECT_CHEMISTRY
  SUBJECT_BIOLOGY
  SUBJECT_ENGINEERING
}

enum CommunityRole {
  ADMIN
  MODERATOR
  MEMBER
}
